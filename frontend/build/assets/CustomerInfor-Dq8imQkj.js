import{r as o,aH as at,bG as rt,at as Ee,au as v,aD as g,cg as nt,bM as S,ch as it,j as s,ax as ct,ay as lt,az as Me,aA as p,aB as f,aC as O,ca as ot,bf as Ye,B as y,cj as ht,ci as q,cf as dt,aO as ut,aE as T}from"./index-D4RF4o2o.js";import{c as pt,P as gt}from"./Pagination-CM1fx-Z6.js";import"./compact-item-CW5ovPyk.js";import"./context-C7AYdI6p.js";import"./useMergedState-CH7lgDWi.js";import"./KeyCode-DNlgD2sM.js";import"./index-B3x69mYG.js";import"./PurePanel-DBA4dq6a.js";import"./index-CjNdeV-b.js";const It=()=>{const V={id:"",name:"",phone:"",provinceId:0,province:"",districtId:0,district:"",wardId:"",ward:"",detail:"",isDefault:!1},Ae={id:"",code:"",name:"",email:"",phone:"",birthDate:"",gender:"Nữ",addressDTOS:[V],status:"Active",totalAddresses:0},[m,j]=o.useState(Ae),[L,W]=o.useState([]),[B,I]=o.useState([]),[H,w]=o.useState([]),[mt,X]=o.useState(!1),[Dt,R]=o.useState(!1),[ft,U]=o.useState(!1),[z,bt]=o.useState(0),[vt,Fe]=o.useState(0),[qe,Ve]=o.useState(0),[P,Le]=o.useState(1),x=3,We=at(),{email:k}=rt(),[E,N]=o.useState([]),[Be,C]=o.useState(!1),[St,G]=o.useState(null),[Tt,He]=o.useState([]),[K,Xe]=o.useState({currentEmail:"",currentPhone:""});o.useEffect(()=>{console.log("Effect running"),k&&F(k,z),ze()},[k,z]),o.useEffect(()=>{if(m.addressDTOS.length>0){const e=[],t=[];(async()=>{await Promise.all(m.addressDTOS.map(async a=>{if(a.provinceId){const i=await M(a.provinceId);e.push(...i)}if(a.districtId){const i=await Y(a.districtId);t.push(...i)}})),I(e),w(t)})()}},[m]);const Re=Ee({name:v().required("Họ tên khách hàng là bắt buộc").min(3,"Họ và tên khách hàng phải có ít nhất 3 ký tự").max(50,"Họ và tên khách hàng không vượt quá 50 ký tự").test("no-whitespace","Họ tên không được chứa nhiều khoảng trắng",e=>e.trim()===e&&!e.includes("  ")).test("no-special-characters","Họ và tên không được chứa ký tự đặc biệt hoặc số",e=>/^[\p{L}\s]+$/u.test(e)),email:v().email("Email không hợp lệ").required("Email là bắt buộc").test("no-whitespace","Email không được chứa khoảng trắng đầu và cuối",e=>e.trim()===e).test("email-gmail","Email phải kết thúc bằng @gmail.com",e=>e?e.endsWith("@gmail.com"):!0).test("email-unique","Email đã tồn tại",async e=>e===K.currentEmail?!0:!(await g.get("http://localhost:8080/api/v1/customer/check-email",{params:{email:e}})).data.exists),phone:v().required("Số điện thoại là bắt buộc").matches(/(03|05|07|08|09|01[2|6|8|9])+([0-9]{8})\b/,"Số điện thoại không hợp lệ").test("phone-unique","Số điện thoại đã tồn tại",async e=>e===K.currentPhone?!0:!(await g.get("http://localhost:8080/api/v1/customer/check-phone",{params:{phone:e}})).data.exists),birthDate:nt().required("Ngày sinh là bắt buộc").max(new Date,"Ngày sinh không được là tương lai").test("age-range","Độ tuổi của bạn không đủ điều kiện để mua hàng",function(e){const t=S().diff(S(e),"year");return t>=5&&t<=100}),gender:v().required("Vui lòng chọn giới tính").oneOf(["Nam","Nữ"],"Giới tính không hợp lệ"),addressDTOS:it().of(Ee().shape({name:v().required("Họ và tên khách hàng là bắt buộc").min(3,"Họ tên khách hàng phải có ít nhất 5 ký tự").max(50,"Họ tên khách hàng không vượt quá 100 ký tự").test("no-whitespace","Họ và tên không được chứa nhiều khoảng trắng",e=>e.trim()===e&&!e.includes("  ")).test("no-special-characters","Họ và tên không được chứa ký tự đặc biệt hoặc số",e=>/^[\p{L}\s]+$/u.test(e)),phone:v().required("Số điện thoại là bắt buộc").matches(/(03|05|07|08|09|01[2|6|8|9])+([0-9]{8})\b/,"Số điện thoại không hợp lệ"),province:v().required("Vui lòng chọn tỉnh/thành phố"),district:v().required("Vui lòng chọn quận/huyện"),ward:v().required("Vui lòng chọn xã/phường/thị trấn"),detail:v().required("Vui lòng nhập địa chỉ cụ thể")}))}),Ue=async()=>{console.log("Fetching provinces..."),X(!0);try{const e=await g.get("https://online-gateway.ghn.vn/shiip/public-api/master-data/province",{headers:{"Content-Type":"application/json",Token:"718f2008-46b7-11ef-b4a4-2ec170e33d11"}});return console.log("API Province Response: ",e),e.data.code===200?e.data.data:(console.log("Error fetching province: ",e.data.message),alert("Không thể tải danh sách tỉnh. Vui lòng thử lại sau."),[])}catch(e){return console.error("Error fetching province:",e),alert("Đã xảy ra lỗi khi tải danh sách tỉnh. Vui lòng thử lại."),[]}finally{X(!1)}},M=async e=>{R(!0);try{const t=await g.get("https://online-gateway.ghn.vn/shiip/public-api/master-data/district",{headers:{"Content-Type":"application/json",Token:"718f2008-46b7-11ef-b4a4-2ec170e33d11"},params:{province_id:e}});return console.log("API District Response: ",t),t.data.code===200?t.data.data:(console.log("Error fetching district: ",t.data.message),alert("Không thể tải danh sách huyện. Vui lòng thử lại sau."),[])}catch(t){return console.error("Error fetching districts:",t),alert("Đã xảy ra lỗi khi tải danh sách huyện. Vui lòng thử lại."),[]}finally{R(!1)}},Y=async e=>{U(!0);try{const t=await g.get("https://online-gateway.ghn.vn/shiip/public-api/master-data/ward",{headers:{"Content-Type":"application/json",Token:"718f2008-46b7-11ef-b4a4-2ec170e33d11"},params:{district_id:e}});return console.log("API Ward Response: ",t),t.data.code===200?t.data.data:(console.log("Error fetching ward: ",t.data.message),alert("Không thể tải danh sách xã. Vui lòng thử lại sau."),[])}catch(t){return console.error("Error fetching wards:",t),alert("Đã xảy ra lỗi khi tải danh sách xã. Vui lòng thử lại."),[]}finally{U(!1)}},A=async(e,t,r,a)=>{if(t)if(e==="province"&&"ProvinceID"in t&&"ProvinceName"in t){r.setFieldValue(`addressDTOS[${a}].province`,t.NameExtension[1]||""),r.setFieldValue(`addressDTOS[${a}].provinceId`,t.ProvinceID);const i=await M(t.ProvinceID);I(i),r.setFieldValue(`addressDTOS[${a}].district`,""),r.setFieldValue(`addressDTOS[${a}].districtId`,0),r.setFieldValue(`addressDTOS[${a}].ward`,""),r.setFieldValue(`addressDTOS[${a}].wardId`,""),w([])}else if(e==="district"&&"DistrictID"in t&&"DistrictName"in t){r.setFieldValue(`addressDTOS[${a}].district`,t.DistrictName||""),r.setFieldValue(`addressDTOS[${a}].districtId`,t.DistrictID);const i=await Y(t.DistrictID);w(i),r.setFieldValue(`addressDTOS[${a}].ward`,""),r.setFieldValue(`addressDTOS[${a}].wardId`,"")}else e==="ward"&&"WardName"in t&&(r.setFieldValue(`addressDTOS[${a}].ward`,t.WardName||""),r.setFieldValue(`addressDTOS[${a}].wardId`,t.WardCode));else r.setFieldValue(`addressDTOS[${a}].${e}`,""),r.setFieldValue(`addressDTOS[${a}].${e}Id`,0)},ze=async()=>{console.log("Loading provinces...");const e=localStorage.getItem("provinces");if(e)console.log("Using cached provinces."),W(JSON.parse(e));else{console.log("Fetching provinces from API...");const t=await Ue();console.log("Fetched provinces:",t),W(t),localStorage.setItem("provinces",JSON.stringify(t))}};S.extend(pt);const Ge=async()=>{try{const e=await g.get("http://localhost:8080/api/v1/address");He(e.data)}catch(e){console.error("Error fetching addresses:",e)}},F=async(e,t)=>{try{const r=await g.get(`http://localhost:8080/api/v1/customer/customer-infor/${e}`,{params:{page:t>0?t-1:0,size:x}});if(r.status===200){const a=r.data;if(console.log("Tổng số địa chỉ: ",a.totalAddresses),console.log("Tổng số trang: ",a.totalAddresses/x),a.totalAddresses&&(Ve(a.totalAddresses),Fe(Math.ceil(a.totalAddresses/x))),Xe({currentEmail:a.email,currentPhone:a.phone}),console.log("Giá trị birthDate từ backend:",a.birthDate),a.birthDate){const i=S(a.birthDate,"DD-MM-YYYY");console.log("Parsed Date:",i.format()),i.isValid()?(a.birthDate=i.format("YYYY-MM-DD"),console.log("Formatted birthDate:",a.birthDate)):console.error("Ngày sinh không hợp lệ:",a.birthDate)}j(a),console.log("Customer data:",a),N(r.data.addressDTOS.map(()=>"edit"))}else console.error("Failed to fetch customer data:",r.statusText)}catch(r){console.error("Error fetching customer data:",r)}},Ke=e=>{G(e),C(!0)},_=()=>{C(!1),G(null)},_e=async(e,t,r,a)=>{if(a.isDefault){C(!1),T.success("Không thể xóa địa chỉ mặc định");return}try{const i=await g.delete(`http://localhost:8080/api/v1/address/delete/${e}`);i.status===200?(T.success("Xóa thành công"),r(t),N(D=>D.filter(($,h)=>h!==t)),C(!1)):(console.error("Lỗi khi xóa địa chỉ:",i.statusText),T.success("Xóa thất bại"))}catch(i){console.error("Lỗi xóa khách hàng:",i),T.success("Xóa thất bại")}},Je=e=>{if(e<1){console.warn("Số trang phải lớn hơn hoặc bằng 1");return}k?(Le(e),F(k,e)):console.error("Email is undefined")},Qe=async(e,{setSubmitting:t})=>{try{if(!S(e.birthDate,"YYYY-MM-DD",!0).isValid()){alert("Ngày sinh không hợp lệ. Vui lòng kiểm tra lại."),t(!1);return}const r=S(e.birthDate,"YYYY-MM-DD").format("DD-MM-YYYY");(await g.put(`http://localhost:8080/api/v1/customer/update/${e.id}`,{...e,birthDate:r})).status===200?(T.success("Cập nhật thành công"),We(`/customer/${k}`)):alert("Failed to update customer. Please try again.")}catch(r){console.error("Error updating customer:",r),alert("Error updating customer. Please try again.")}finally{t(!1)}},Ze=async(e,t,r,a,i,D,$,h)=>{try{if(!t.name||!t.phone||!t.province||!t.district||!t.ward||!t.detail){D(`addressDTOS[${i}].name`,!0),D(`addressDTOS[${i}].phone`,!0),D(`addressDTOS[${i}].province`,!0),D(`addressDTOS[${i}].district`,!0),D(`addressDTOS[${i}].ward`,!0),D(`addressDTOS[${i}].detail`,!0);return}let l;if(e==="add")l=await g.post(`http://localhost:8080/api/v1/customer/${a}/address`,t),console.log("Dữ liệu địa chỉ vừa thêm:",l.data),l.status===201&&($("addressDTOS",[l.data,...h.addressDTOS]),N(d=>["edit",...d])),T.success("Thêm địa chỉ mới thành công");else{l=await g.put(`http://localhost:8080/api/v1/address/update/${r}`,{...t,districtId:t.districtId,wardId:t.wardId});const d=[...h.addressDTOS];d[i]=l.data,console.log("dữ liệu cập nhật lại địa chỉ: ",d),T.success("Cập nhật địa chỉ thành công")}F(a,P)}catch(l){console.error("Error submitting address:",l),alert("Error submitting address. Please try again.")}},et=async(e,t)=>{try{console.log("Updating address ID:",e,"to default:",t);const r=await g.put(`http://localhost:8080/api/v1/customer/${e}/default`,null,{params:{customerId:m.id,isDefault:t}});r.status===200?(console.log("Địa chỉ đã được cập nhật thành công:",r.data),Ge()):console.error("Cập nhật địa chỉ không thành công:",r.statusText)}catch(r){console.error("Lỗi khi cập nhật địa chỉ:",r)}},tt=async(e,t)=>{try{const r=m.addressDTOS.map((a,i)=>({...a,isDefault:i===e}));j({...m,addressDTOS:r}),T.success("cập nhật địa chỉ mặc định thành công"),await et(m.addressDTOS[e].id,!0)}catch(r){console.error("Lỗi khi cập nhật địa chỉ mặc định:",r)}},st=async e=>{if(e.addressDTOS[0].provinceId){const t=await M(e.addressDTOS[0].provinceId);if(I(t),e.addressDTOS[0].districtId){const r=await Y(e.addressDTOS[0].districtId);w(r)}}};return s.jsx(ct,{initialValues:m,validationSchema:Re,enableReinitialize:!0,onSubmit:Qe,children:({values:e,setFieldValue:t,touched:r,errors:a,resetForm:i,isSubmitting:D,setFieldTouched:$})=>s.jsx(lt,{children:s.jsxs("div",{className:"w-full bg-white p-6 shadow-md rounded-lg",children:[s.jsx("h1",{className:"text-center font-semibold text-2xl mb-4 uppercase",children:"Cập nhật khách hàng"}),s.jsxs("div",{className:"flex flex-col lg:flex-row gap-4",children:[s.jsxs("div",{className:"w-full lg:w-1/3 bg-white p-6 shadow-md rounded-lg",children:[s.jsx("h4",{className:"font-medium text-xl mb-4",children:"Thông tin khách hàng"}),s.jsxs(Me,{children:[s.jsx(p,{asterisk:!0,label:"Tên khách hàng",invalid:a.name&&r.name,errorMessage:a.name,children:s.jsx(f,{type:"text",autoComplete:"off",name:"name",style:{height:"44px"},placeholder:"Tên khách hàng...",component:O})}),s.jsx(p,{asterisk:!0,label:"Email",invalid:a.email&&r.email,errorMessage:a.email,children:s.jsx(f,{type:"text",autoComplete:"off",name:"email",style:{height:"44px"},placeholder:"Email...",component:O})}),s.jsx(p,{asterisk:!0,label:"Số điện thoại",invalid:a.phone&&r.phone,errorMessage:a.phone,children:s.jsx(f,{type:"text",autoComplete:"off",name:"phone",style:{height:"44px"},placeholder:"Số điện thoại...",component:O,onChange:h=>{const l=h.target.value.replace(/\D/g,"");t("phone",l),j(d=>({...d,phone:l}))}})}),s.jsx(p,{asterisk:!0,label:"Ngày sinh",invalid:a.birthDate&&r.birthDate,errorMessage:a.birthDate,children:s.jsx(ot,{inputtable:!0,inputtableBlurClose:!1,placeholder:"Chọn ngày sinh...",value:m.birthDate?S(m.birthDate,"YYYY-MM-DD").toDate():null,disableDate:h=>S(h).isAfter(S().endOf("day")),className:"custom-datepicker",onChange:h=>{if(h){const l=S(h).format("YYYY-MM-DD");t("birthDate",l),j(d=>({...d,birthDate:l}))}else t("birthDate",""),j(l=>({...l,birthDate:""}))}})}),s.jsx(p,{asterisk:!0,label:"Giới tính",children:s.jsx(f,{name:"gender",children:({field:h,form:l})=>s.jsxs(s.Fragment,{children:[s.jsx(Ye,{className:"mr-4",value:"Nam",checked:h.value==="Nam",onChange:()=>l.setFieldValue("gender","Nam"),children:"Nam"}),s.jsx(Ye,{value:"Nữ",checked:h.value==="Nữ",onChange:()=>l.setFieldValue("gender","Nữ"),children:"Nữ"})]})})}),s.jsxs(p,{children:[s.jsx(y,{type:"reset",className:"ltr:mr-2 rtl:ml-2",style:{backgroundColor:"#fff",height:"40px"},disabled:D,onClick:()=>{i(),st(m)},children:"Tải lại"}),s.jsx(y,{variant:"solid",type:"submit",style:{backgroundColor:"rgb(79, 70, 229)",height:"40px"},disabled:D,children:"Cập nhật"})]})]})]}),s.jsxs("div",{className:"w-full lg:w-2/3 bg-white p-6 shadow-md rounded-lg",children:[s.jsx("h4",{className:"font-medium text-xl",children:"Thông tin địa chỉ"}),s.jsx(ht,{name:"addressDTOS",children:({remove:h,unshift:l})=>s.jsxs("div",{children:[s.jsx(y,{type:"button",className:"mb-4 mt-4",onClick:()=>{l(V),N(["add",...E])},children:"Thêm địa chỉ mới"}),e.addressDTOS.map((d,n)=>{var J,Q,Z,ee,te,se,ae,re,ne,ie,ce,le,oe,he,de,ue,pe,ge,me,De,fe,be,ve,Se,Te,ye,ke,Oe,je,xe,we,Ne,Ce,$e,Ie,Pe;return s.jsxs("div",{className:"bg-white p-6 shadow-md rounded-lg mb-6",children:[s.jsxs(Me,{children:[s.jsxs("h4",{className:"text-lg font-medium mb-2",children:["Địa chỉ ",(P-1)*x+n+1]}),s.jsxs("div",{className:"flex w-full flex-wrap mb-4",children:[s.jsx("div",{className:"w-1/2 pr-4",children:s.jsx(p,{asterisk:!0,label:"Tên",invalid:((Q=(J=a.addressDTOS)==null?void 0:J[n])==null?void 0:Q.name)&&((ee=(Z=r.addressDTOS)==null?void 0:Z[n])==null?void 0:ee.name),errorMessage:(se=(te=a.addressDTOS)==null?void 0:te[n])==null?void 0:se.name,children:s.jsx(f,{type:"text",name:`addressDTOS[${n}].name`,style:{height:"44px"},placeholder:"Nhập tên...",component:O})})}),s.jsx("div",{className:"w-1/2",children:s.jsx(p,{asterisk:!0,label:"Số điện thoại",invalid:((re=(ae=a.addressDTOS)==null?void 0:ae[n])==null?void 0:re.phone)&&((ie=(ne=r.addressDTOS)==null?void 0:ne[n])==null?void 0:ie.phone),errorMessage:(le=(ce=a.addressDTOS)==null?void 0:ce[n])==null?void 0:le.phone,children:s.jsx(f,{type:"text",name:`addressDTOS[${n}].phone`,style:{height:"44px"},placeholder:"Nhập số điện thoại...",component:O})})})]}),s.jsxs("div",{className:"flex w-full flex-wrap mb-4",children:[s.jsx("div",{className:"w-1/3 pr-4",children:s.jsx(p,{asterisk:!0,label:"Tỉnh/Thành phố",invalid:((he=(oe=r.addressDTOS)==null?void 0:oe[n])==null?void 0:he.province)&&!!((ue=(de=a.addressDTOS)==null?void 0:de[n])!=null&&ue.province),errorMessage:(ge=(pe=a.addressDTOS)==null?void 0:pe[n])==null?void 0:ge.province,children:s.jsx(f,{name:`addressDTOS[${n}].province`,children:({field:u,form:b})=>(console.log("Dữ liệu tỉnh:",u.value),s.jsx(q,{value:L.find(c=>c.NameExtension[1]===u.value),placeholder:"Chọn tỉnh/thành phố...",getOptionLabel:c=>c.NameExtension[1],getOptionValue:c=>String(c.ProvinceID),options:L,onChange:c=>{A("province",c,b,n)},onBlur:()=>b.setFieldTouched(u.value,!0)}))})})}),s.jsx("div",{className:"w-1/3 pr-4",children:s.jsx(p,{asterisk:!0,label:"Quận/huyện",invalid:((De=(me=r.addressDTOS)==null?void 0:me[n])==null?void 0:De.district)&&!!((be=(fe=a.addressDTOS)==null?void 0:fe[n])!=null&&be.district),errorMessage:(Se=(ve=a.addressDTOS)==null?void 0:ve[n])==null?void 0:Se.district,children:s.jsx(f,{name:`addressDTOS[${n}].district`,children:({field:u,form:b})=>(console.log("Dữ liệu quận:",u.value),s.jsx(q,{isDisabled:!d.province,value:B.find(c=>c.DistrictName===u.value),placeholder:"Chọn quận/huyện...",getOptionLabel:c=>c.DistrictName,getOptionValue:c=>String(c.DistrictID),options:B,onChange:c=>{A("district",c,b,n)},onBlur:()=>b.setFieldTouched(u.value,!0)}))})})}),s.jsx("div",{className:"w-1/3",children:s.jsx(p,{asterisk:!0,label:"Xã/phường/thị trấn",invalid:((ye=(Te=r.addressDTOS)==null?void 0:Te[n])==null?void 0:ye.ward)&&!!((Oe=(ke=a.addressDTOS)==null?void 0:ke[n])!=null&&Oe.ward),errorMessage:(xe=(je=a.addressDTOS)==null?void 0:je[n])==null?void 0:xe.ward,children:s.jsx(f,{name:`addressDTOS[${n}].ward`,children:({field:u,form:b})=>(console.log("Dữ liệu xã:",u.value),s.jsx(q,{isDisabled:!d.district,value:H.find(c=>c.WardName===u.value),placeholder:"Chọn xã/phường/thị trấn...",getOptionLabel:c=>c.WardName,getOptionValue:c=>String(c.WardCode),options:H,onChange:c=>{A("ward",c,b,n)},onBlur:()=>b.setFieldTouched(u.value,!0)}))})})})]}),s.jsx(p,{asterisk:!0,label:"Địa chỉ chi tiết",invalid:((Ne=(we=a.addressDTOS)==null?void 0:we[n])==null?void 0:Ne.detail)&&(($e=(Ce=r.addressDTOS)==null?void 0:Ce[n])==null?void 0:$e.detail),errorMessage:(Pe=(Ie=a.addressDTOS)==null?void 0:Ie[n])==null?void 0:Pe.detail,children:s.jsx(f,{type:"text",name:`addressDTOS[${n}].detail`,style:{height:"44px"},placeholder:"Nhập địa chỉ chi tiết",component:O})}),s.jsx(p,{label:"Địa chỉ mặc định",children:s.jsx(f,{name:`addressDTOS[${n}].isDefault`,children:({field:u})=>s.jsx(dt,{color:"blue-600",checked:u.value,onChange:b=>{t(`addressDTOS[${n}].isDefault`,b),tt(n)}})})}),s.jsxs("div",{className:"flex justify-end",children:[s.jsx(y,{type:"button",className:"mr-4",variant:"solid",style:{backgroundColor:"rgb(79, 70, 229)",height:"40px"},onClick:()=>Ze(E[n],e.addressDTOS[n],d.id,e.id,n,$,t,e),children:E[n]==="add"?"Thêm":"Cập nhật"}),s.jsx(y,{type:"button",variant:"default",style:{backgroundColor:"#fff",height:"40px"},onClick:()=>Ke(d.id),children:"Xóa"})]})]}),s.jsxs(ut,{isOpen:Be,closable:!1,onClose:_,children:[s.jsx("h5",{className:"mb-4",children:"Xác nhận xóa địa chỉ"}),s.jsx("p",{children:"Bạn có chắc chắn muốn xóa địa chỉ này không?"}),s.jsxs("div",{className:"text-right mt-6",children:[s.jsx(y,{className:"ltr:mr-2 rtl:ml-2",variant:"plain",onClick:_,children:"Hủy"}),s.jsx(y,{variant:"solid",style:{backgroundColor:"rgb(79, 70, 229)",height:"40px"},type:"submit",onClick:()=>_e(d.id,n,h,d),children:"Xác nhận"})]})]})]},n)})]})}),s.jsx("div",{children:s.jsx(gt,{current:P,pageSize:x,total:qe,onChange:Je})})]})]})]})})})};export{It as default};
