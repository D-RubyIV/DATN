import{bc as F,r as c,at as V,au as M,aI as es,j as s,bd as S,aO as ns,ax as as,ay as ts,aB as is,aC as R,be as os,B as l,b2 as m,as as y,bf as E,a_ as $,c3 as G,bg as I,cQ as cs,cR as K,bG as rs,E as ls,bH as ds,L as hs,T as us,aK as ms,bn as xs,bI as z,bJ as gs,bK as ps,a7 as fs,bL as Ns,bM as js}from"./index-D8wAv7Ri.js";import{i as vs,o as ys,O as Es,j as Cs,P as bs}from"./ClassicLayout-CF154tbn.js";const Ss=({selectObject:e,fetchData:x})=>{const{setIsLoadingComponent:N}=F(),[i,r]=c.useState(),[g,j]=c.useState();c.useEffect(()=>{var o;const n=e.historyResponseDTOS.length;j(n>0?(o=e.historyResponseDTOS[n-1])==null?void 0:o.status:void 0)},[e]);const h=V().shape({transactionCode:M().required("Mã giao dịch là bắt buộc").min(6,"Mã giao dịch phải có ít nhất 6 ký tự")}),a=async n=>{console.log(n);const o={amount:i==="FOR_TOSHIP"?e.refund:e.totalPaid,tradingCode:n.transactionCode,status:i==="FOR_TOSHIP"?m.TOSHIP:m.CANCELED};await y.post(`orders/refund_and_change_status/${e.id}`,o).then(function(t){console.log(t),t.status===200&&p("Thay đổi trạng thái thành công"),v(!1),x()})},{openNotification:p}=es(),{sleepLoading:D}=F(),_=V({note:M().required("Vui lòng nhập nội dung").min(5,"Nội dung phải có ít nhất 5 ký tự")}),{register:U,handleSubmit:u,formState:{errors:k},getValues:w,setValue:C}=vs({resolver:ys(_),mode:"onChange"});c.useEffect(()=>{C("note","")},[]);const O=c.useRef(null),Q=()=>{O.current&&O.current.focus()},X=async()=>{try{const n=await y.get(`orders/exportPdf/${e.id}`,{responseType:"blob"}),o=window.URL.createObjectURL(new Blob([n.data],{type:"application/pdf"})),t=document.createElement("iframe");t.style.display="none",t.src=o,t.onload=()=>{t.contentWindow&&t.contentWindow.print()},document.body.appendChild(t),t.addEventListener("load",()=>{setTimeout(()=>{document.body.removeChild(t),window.URL.revokeObjectURL(o)},6e5)})}catch(n){console.error("Failed to print PDF",n)}},[d,B]=c.useState(e.status),Y=[{status:"PENDING",messages:["Đã xác nhận đơn hàng","Khách muốn hủy đơn"]},{status:"TOSHIP",messages:["Xác nhận đơn hàng đang được vận chuyển","Khách hàng muốn chỉnh sửa giỏ hàng"]},{status:"TORECEIVE",messages:["Xác nhận hoàn thành đơn hàng","Khách chưa nhận được hàng"]},{status:"REQUESTED",messages:["Xác nhận hủy và hoàn trả"]}],[q,v]=c.useState(!1),T=()=>{v(!1)};c.useEffect(()=>{B(e.status),console.log("Current status: ",e.status)},[e]);const P=n=>{console.log(n),C("note",n)},W=n=>{C("note",n.target.value)},f=async n=>{const o={status:n,note:w("note")};await D(500).then(async()=>{y.put(`/orders/status/change/${e.id}`,o).then(function(t){N(!0),t.status===200&&(p("Thay đổi trạng thái thành công"),n==="TOSHIP"&&X()),x(),C("note","")}).catch(function(t){var b,L,H,A;console.log("-----"),console.log(t.response),(L=(b=t==null?void 0:t.response)==null?void 0:b.data)!=null&&L.error&&p((A=(H=t==null?void 0:t.response)==null?void 0:H.data)==null?void 0:A.error,"Thông báo","warning",5e3)}).finally(function(){N(!1)})})},J=()=>{if(d==="PENDING"&&g!=="REQUESTED")return s.jsxs("div",{className:"flex gap-2",children:[e.type==="ONLINE"&&e.refund>0?s.jsx(l,{block:!0,variant:"solid",size:"sm",className:"bg-indigo-500 !w-auto",disabled:e.orderDetailResponseDTOS.length===0,icon:s.jsx($,{}),onClick:u(async()=>{r("FOR_TOSHIP"),v(!0)}),children:"Trả lại tiền và chuyển sang chờ vận chuyển"}):e.type==="ONLINE"?s.jsx(l,{block:!0,variant:"solid",size:"sm",className:"bg-indigo-500 !w-auto",disabled:e.orderDetailResponseDTOS.length===0,icon:s.jsx($,{}),onClick:u(async()=>f("TOSHIP")),children:"Chuyển trạng thái chờ vận chuyển"}):s.jsx(l,{block:!0,variant:"solid",size:"sm",className:"bg-indigo-500 !w-auto",disabled:e.orderDetailResponseDTOS.length===0,icon:s.jsx(G,{}),onClick:u(async()=>f("DELIVERED")),children:"Xác nhận giao hàng"}),e.isPayment?s.jsx(l,{block:!0,variant:"default",size:"sm",className:"bg-indigo-500",icon:s.jsx(I,{}),onClick:u(async()=>{r("FOR_CANCEL"),v(!0)}),children:"Trả lại tiền và hủy đơn"}):s.jsx(l,{block:!0,variant:"default",size:"sm",className:"bg-indigo-500 !w-32",icon:s.jsx(I,{}),onClick:u(async()=>f("CANCELED")),children:"Hủy đơn hàng"})]});if(d==="PENDING"&&g==="REQUESTED")return s.jsx("div",{className:"flex gap-2",children:s.jsx(l,{block:!0,variant:"default",size:"sm",className:"bg-indigo-500",icon:s.jsx(I,{}),onClick:u(async()=>{r("FOR_CANCEL"),v(!0)}),children:"Trả lại tiền và hủy đơn"})});if(d==="TOSHIP")return s.jsxs("div",{className:"flex gap-2",children:[s.jsx(l,{block:!0,variant:"solid",size:"sm",className:"bg-indigo-500 !w-auto",icon:s.jsx(cs,{}),onClick:u(async()=>f("TORECEIVE")),children:"Xác nhận đang vận chuyển "}),s.jsx(l,{block:!0,variant:"default",size:"sm",className:"bg-indigo-500 !w-auto",icon:s.jsx(K,{}),onClick:u(async()=>f("PENDING")),children:"Quay lại chờ xác nhận"})]});if(d==="TORECEIVE")return s.jsxs("div",{className:"flex gap-2",children:[s.jsx(l,{block:!0,variant:"solid",size:"sm",className:"bg-indigo-500 !w-auto",icon:s.jsx(G,{}),onClick:u(async()=>f("DELIVERED")),children:"Xác nhận hoàn thành"}),s.jsx(l,{block:!0,variant:"default",size:"sm",className:"bg-indigo-500 !w-auto",icon:s.jsx(K,{}),onClick:u(async()=>f("PENDING")),children:"Quay lại chờ xác nhận"})]});if(d==="DELIVERED")return s.jsx("div",{className:"flex gap-2"})},Z=()=>{var o;const n=(o=Y.find(t=>t.status===g))==null?void 0:o.messages;return s.jsxs("div",{children:[s.jsxs("div",{className:"mb-4",children:[s.jsx("div",{className:"",children:s.jsx("div",{className:"mt-4",children:n&&n.length>0?s.jsxs(E.Group,{vertical:!0,value:w("note"),children:[n.map((t,b)=>s.jsx(E,{value:t,onClick:()=>P(t),children:t},b)),s.jsx(E,{value:"",onClick:()=>P(""),children:"Khác"})]}):s.jsx("div",{children:d&&s.jsx(c.Fragment,{children:s.jsx("div",{className:"text-[15px] font-semibold text-center py-5",children:d==="DELIVERED"?"Đơn hàng được giao thành công":d==="CANCELED"?"Trạng thái đơn hàng bị hủy":null})})})})}),s.jsxs("div",{className:"col-span-4",hidden:d==="DELIVERED"||d==="CANCELED",children:[s.jsx(R,{placeholder:"Nhập nội dung",...U("note"),textArea:!0,width:600,className:"!w-full !min-h-12",rows:2,onFocus:Q,onChange:W}),k.note&&s.jsx("p",{className:"text-red-500 text-sm mt-2",children:k.note.message})]})]}),s.jsx("div",{className:"flex gap-5 justify-end",children:J()})]})},ss=n=>n===m.PENDING?"Chờ xác nhận":n===m.TOSHIP?"Chờ vận chuyển":n===m.TORECEIVE?"Đang vận chuyển":n===m.DELIVERED?"Đã giao hàng":n===m.CANCELED?"Đã hủy":n===m.REQUESTED?"Yêu cầu hủy và hoàn trả":"Không xác định";return s.jsxs("div",{className:"bg-white p-5 card card-border  h-auto",children:[s.jsx("div",{className:"max-w-full py-5 overflow-auto",children:e.historyResponseDTOS.length>0?s.jsx(S,{current:e.historyResponseDTOS.length,children:e.historyResponseDTOS.map((n,o)=>s.jsx(S.Item,{title:ss(n.status),className:"pr-20"},o))}):s.jsx(S,{current:0,children:s.jsx(S.Item,{title:d})})}),s.jsx("div",{className:"dark:bg-gray-700 rounded",children:s.jsx(Z,{})}),s.jsxs(ns,{isOpen:q,onClose:T,onRequestClose:T,children:[s.jsx("h5",{className:"mb-4",children:"Nhập mã giao dịch"}),s.jsxs("div",{className:"flex gap-2 pb-4",children:[s.jsx("p",{className:"text-black",children:"Số tiền cần trả lại: "}),s.jsx("p",{className:"text-red-500",children:i==="FOR_CANCEL"?`${e.totalPaid.toLocaleString("vi")}`:`${e.refund.toLocaleString("vi")}đ`})]}),s.jsx(as,{initialValues:{transactionCode:""},validationSchema:h,onSubmit:a,children:({errors:n,touched:o,isSubmitting:t})=>s.jsxs(ts,{children:[s.jsxs("div",{children:[s.jsx(is,{name:"transactionCode",as:R,placeholder:"Vui lòng nhập mã giao dịch",className:`${n.transactionCode&&o.transactionCode?"border-red-500":""}`}),s.jsx(os,{name:"transactionCode",component:"div",className:"text-red-500 text-sm mt-1"})]}),s.jsxs("div",{className:"text-right mt-6",children:[s.jsx(l,{className:"ltr:mr-2 rtl:ml-2",variant:"plain",type:"button",onClick:T,children:"Hủy"}),s.jsx(l,{variant:"solid",type:"submit",disabled:t,children:"Xác nhận"})]})]})})]})]})},Rs=()=>{const{id:e}=rs(),[x,N]=c.useState({subTotal:10,tax:10,deliveryFee:10,discount:1e3,total:1e3,surcharge:0,refund:0,totalPaid:0,totalAfterDiscountAndFee:0}),[i,r]=c.useState(),[g,j]=c.useState([]);c.useEffect(()=>{h()},[e]);const h=async()=>{await y.get(`/orders/${e}`).then(function(a){console.log(a),r(a.data),j(a.data.orderDetailResponseDTOS),N({subTotal:a.data.subTotal||0,tax:a.data.tax||0,deliveryFee:a.data.deliveryFee||0,discount:a.data.discount||0,total:a.data.total||0,surcharge:a.data.surcharge||0,refund:a.data.refund||0,totalPaid:a.data.totalPaid||0,totalAfterDiscountAndFee:a.data.totalAfterDiscountAndFee||0})})};return c.useEffect(()=>{console.log("Selected Bill: ",i)},[i]),s.jsx("div",{children:s.jsx("div",{children:s.jsxs("div",{className:"2xl:grid 2xl:grid-cols-12 2xl:gap-5",children:[s.jsx("div",{className:"md:col-span-8 2xl:h-full",children:s.jsxs("div",{className:"flex flex-col gap-5 2xl:h-full",children:[i!==void 0&&s.jsx(Ss,{selectObject:i,fetchData:h}),i!==void 0&&s.jsx(Es,{data:g,fetchData:h,selectObject:i})]})}),s.jsxs("div",{className:"md:col-span-4",children:[i!==void 0&&s.jsx(Cs,{data:i}),i!==void 0&&s.jsx(Ds,{data:i,fetchData:h}),i!==void 0&&s.jsx(bs,{data:x,selectObject:i,fetchData:h})]})]})})})},Ds=({data:e,fetchData:x})=>{var j,h;const[N,i]=c.useState(!1),r=(e==null?void 0:e.customerResponseDTO)||{},g=async a=>{console.log(a);const p={provinceId:a.provinceId,provinceName:a.province,districtId:a.districtId,districtName:a.district,wardId:a.wardId,wardName:a.ward,address:a.detail,recipientName:a.name,phone:a.phone};await y.put(`/orders/${e.id}`,p).then(function(D){console.log(D),x()})};return s.jsxs(ls,{className:"mb-5 max-h-[420px] h-auto",children:[N&&s.jsx(ds,{selectedOrder:e,onCloseModal:i,fetchData:x}),s.jsxs("h5",{className:"mb-4",children:["Khách hàng #",r.code||"Khách lẻ"]}),s.jsxs(hs,{className:"group flex items-center justify-between",to:"/app/crm/customer-details?id=11",children:[s.jsxs("div",{className:"flex items-center",children:[s.jsx(us,{icon:s.jsx(ms,{})}),s.jsx("div",{className:"ltr:ml-2 rtl:mr-2",children:s.jsx("div",{className:"font-semibold group-hover:text-gray-900 group-hover:dark:text-gray-100",children:r.email||"Khách lẻ"})})]}),s.jsx(xs,{className:"text-xl hidden group-hover:block"})]}),s.jsx("hr",{className:"my-5"}),r.code&&s.jsxs("div",{children:[s.jsx(z,{className:"mb-4",icon:s.jsx(gs,{className:"text-xl opacity-70"}),children:s.jsx("span",{className:"font-semibold",children:r.email||""})}),s.jsx(z,{icon:s.jsx(ps,{className:"text-xl opacity-70"}),children:s.jsx("span",{className:"font-semibold",children:r.phone||""})})]}),s.jsx("hr",{className:"my-5"}),s.jsxs("div",{className:`${e.type==="INSTORE"?"max-h-[0px]":"max-h-[600px]"} overflow-hidden duration-700 transition-all  font-semibold text-gray-500`,children:[s.jsx("h6",{className:"mb-4",children:"Địa chỉ nhận hàng"}),s.jsxs("address",{className:"not-italic",children:[s.jsx("div",{className:"mb-4",children:s.jsx(R,{disabled:!0,value:e.address+", "+e.wardName+", "+e.districtName+", "+e.provinceName,suffix:s.jsx(fs,{title:"Field info",children:s.jsx(Ns,{className:`text-lg cursor-pointer ml-1 ${e.status==="PENDING"?"":"hidden"}`,onClick:()=>i(!0)})})})}),r.code?s.jsx("div",{children:s.jsx(E.Group,{vertical:!0,children:(h=(j=e.customerResponseDTO)==null?void 0:j.addressResponseDTOS)!=null&&h.length?e.customerResponseDTO.addressResponseDTOS.map((a,p)=>s.jsxs(E,{value:a.id,disabled:e.status!=="PENDING",onClick:()=>g(a),children:[a.phone," - ",a.detail]},p)):s.jsx("div",{className:"flex justify-center items-center",children:s.jsx("div",{className:"py-2",children:s.jsx("p",{children:"Không có bất kì địa chỉ nào khác"})})})})}):s.jsxs("div",{className:"flex flex-col gap-3 font-semibold",children:[s.jsx("div",{children:s.jsxs("p",{children:["Tên người nhận: ",e.recipientName]})}),s.jsx("div",{children:s.jsxs("p",{children:["Số điện thoại nhận: ",e.phone]})}),s.jsx("div",{children:s.jsxs("p",{children:["Thời gian đặt: ",js(e.createdDate).format("DD/MM/YYYY HH:mm:ss")]})}),s.jsx("div",{children:s.jsxs("p",{children:["Phương thức thanh toán: ",e.payment==="CASH"?"Thanh toán khi nhận hàng":"Chuyển khoản trước"]})})]}),s.jsx("ul",{})]})]})]})};export{Rs as default};
