import{r as o,aH as rt,bG as nt,at as Me,au as S,aD as g,ak as T,cg as it,bM as v,ch as ct,j as s,ax as lt,ay as ot,az as Ye,aA as p,aB as f,aC as O,ca as dt,bf as Ae,B as k,cj as ht,ci as V,cf as ut,aO as pt,aE as x}from"./index-BTLFdfuL.js";import{c as gt,P as mt}from"./Pagination-DroOJpkf.js";import"./compact-item-C7DsvHyE.js";import"./context-i94UR_O8.js";import"./useMergedState-ZQFHgE31.js";import"./KeyCode-DNlgD2sM.js";import"./index-CXcG97ny.js";import"./PurePanel-BjasDhdK.js";import"./index-CjFs4mbI.js";const It=()=>{const L={id:"",name:"",phone:"",provinceId:0,province:"",districtId:0,district:"",wardId:"",ward:"",detail:"",isDefault:!1},Fe={id:"",code:"",name:"",email:"",phone:"",birthDate:"",gender:"Nữ",addressDTOS:[L],status:"Active",totalAddresses:0},[m,j]=o.useState(Fe),[W,B]=o.useState([]),[H,I]=o.useState([]),[X,N]=o.useState([]),[Dt,R]=o.useState(!1),[ft,U]=o.useState(!1),[bt,z]=o.useState(!1),[G,St]=o.useState(0),[vt,qe]=o.useState(0),[Ve,Le]=o.useState(0),[E,We]=o.useState(1),w=3,Be=rt(),{email:y}=nt(),[M,C]=o.useState([]),[He,$]=o.useState(!1),[Tt,K]=o.useState(null),[xt,Xe]=o.useState([]),[_,Re]=o.useState({currentEmail:"",currentPhone:""});o.useEffect(()=>{console.log("Effect running"),y&&q(y,G),Ge()},[y,G]),o.useEffect(()=>{if(m.addressDTOS.length>0){const e=[],t=[];(async()=>{await Promise.all(m.addressDTOS.map(async a=>{if(a.provinceId){const i=await Y(a.provinceId);e.push(...i)}if(a.districtId){const i=await A(a.districtId);t.push(...i)}})),I(e),N(t)})()}},[m]);const Ue=Me({name:S().required("Họ tên khách hàng là bắt buộc").min(3,"Họ và tên khách hàng phải có ít nhất 3 ký tự").max(50,"Họ và tên khách hàng không vượt quá 50 ký tự").test("no-whitespace","Họ tên không được chứa nhiều khoảng trắng",e=>e.trim()===e&&!e.includes("  ")).test("no-special-characters","Họ và tên không được chứa ký tự đặc biệt hoặc số",e=>/^[\p{L}\s]+$/u.test(e)),email:S().email("Email không hợp lệ").required("Email là bắt buộc").test("no-whitespace","Email không được chứa khoảng trắng đầu và cuối",e=>e.trim()===e).test("email-gmail","Email phải kết thúc bằng @gmail.com",e=>e?e.endsWith("@gmail.com"):!0).test("email-unique","Email đã tồn tại",async e=>e===_.currentEmail?!0:!(await g.get(`${T.apiPrefix}/customer/check-email`,{params:{email:e}})).data.exists),phone:S().required("Số điện thoại là bắt buộc").matches(/(03|05|07|08|09|01[2|6|8|9])+([0-9]{8})\b/,"Số điện thoại không hợp lệ").test("phone-unique","Số điện thoại đã tồn tại",async e=>e===_.currentPhone?!0:!(await g.get(`${T.apiPrefix}/customer/check-phone`,{params:{phone:e}})).data.exists),birthDate:it().required("Ngày sinh là bắt buộc").max(new Date,"Ngày sinh không được là tương lai").test("age-range","Độ tuổi của bạn không đủ điều kiện để mua hàng",function(e){const t=v().diff(v(e),"year");return t>=5&&t<=100}),gender:S().required("Vui lòng chọn giới tính").oneOf(["Nam","Nữ"],"Giới tính không hợp lệ"),addressDTOS:ct().of(Me().shape({name:S().required("Họ và tên khách hàng là bắt buộc").min(3,"Họ tên khách hàng phải có ít nhất 5 ký tự").max(50,"Họ tên khách hàng không vượt quá 100 ký tự").test("no-whitespace","Họ và tên không được chứa nhiều khoảng trắng",e=>e.trim()===e&&!e.includes("  ")).test("no-special-characters","Họ và tên không được chứa ký tự đặc biệt hoặc số",e=>/^[\p{L}\s]+$/u.test(e)),phone:S().required("Số điện thoại là bắt buộc").matches(/(03|05|07|08|09|01[2|6|8|9])+([0-9]{8})\b/,"Số điện thoại không hợp lệ"),province:S().required("Vui lòng chọn tỉnh/thành phố"),district:S().required("Vui lòng chọn quận/huyện"),ward:S().required("Vui lòng chọn xã/phường/thị trấn"),detail:S().required("Vui lòng nhập địa chỉ cụ thể")}))}),ze=async()=>{console.log("Fetching provinces..."),R(!0);try{const e=await g.get("https://online-gateway.ghn.vn/shiip/public-api/master-data/province",{headers:{"Content-Type":"application/json",Token:"718f2008-46b7-11ef-b4a4-2ec170e33d11"}});return console.log("API Province Response: ",e),e.data.code===200?e.data.data:(console.log("Error fetching province: ",e.data.message),alert("Không thể tải danh sách tỉnh. Vui lòng thử lại sau."),[])}catch(e){return console.error("Error fetching province:",e),alert("Đã xảy ra lỗi khi tải danh sách tỉnh. Vui lòng thử lại."),[]}finally{R(!1)}},Y=async e=>{U(!0);try{const t=await g.get("https://online-gateway.ghn.vn/shiip/public-api/master-data/district",{headers:{"Content-Type":"application/json",Token:"718f2008-46b7-11ef-b4a4-2ec170e33d11"},params:{province_id:e}});return console.log("API District Response: ",t),t.data.code===200?t.data.data:(console.log("Error fetching district: ",t.data.message),alert("Không thể tải danh sách huyện. Vui lòng thử lại sau."),[])}catch(t){return console.error("Error fetching districts:",t),alert("Đã xảy ra lỗi khi tải danh sách huyện. Vui lòng thử lại."),[]}finally{U(!1)}},A=async e=>{z(!0);try{const t=await g.get("https://online-gateway.ghn.vn/shiip/public-api/master-data/ward",{headers:{"Content-Type":"application/json",Token:"718f2008-46b7-11ef-b4a4-2ec170e33d11"},params:{district_id:e}});return console.log("API Ward Response: ",t),t.data.code===200?t.data.data:(console.log("Error fetching ward: ",t.data.message),alert("Không thể tải danh sách xã. Vui lòng thử lại sau."),[])}catch(t){return console.error("Error fetching wards:",t),alert("Đã xảy ra lỗi khi tải danh sách xã. Vui lòng thử lại."),[]}finally{z(!1)}},F=async(e,t,r,a)=>{if(t)if(e==="province"&&"ProvinceID"in t&&"ProvinceName"in t){r.setFieldValue(`addressDTOS[${a}].province`,t.NameExtension[1]||""),r.setFieldValue(`addressDTOS[${a}].provinceId`,t.ProvinceID);const i=await Y(t.ProvinceID);I(i),r.setFieldValue(`addressDTOS[${a}].district`,""),r.setFieldValue(`addressDTOS[${a}].districtId`,0),r.setFieldValue(`addressDTOS[${a}].ward`,""),r.setFieldValue(`addressDTOS[${a}].wardId`,""),N([])}else if(e==="district"&&"DistrictID"in t&&"DistrictName"in t){r.setFieldValue(`addressDTOS[${a}].district`,t.DistrictName||""),r.setFieldValue(`addressDTOS[${a}].districtId`,t.DistrictID);const i=await A(t.DistrictID);N(i),r.setFieldValue(`addressDTOS[${a}].ward`,""),r.setFieldValue(`addressDTOS[${a}].wardId`,"")}else e==="ward"&&"WardName"in t&&(r.setFieldValue(`addressDTOS[${a}].ward`,t.WardName||""),r.setFieldValue(`addressDTOS[${a}].wardId`,t.WardCode));else r.setFieldValue(`addressDTOS[${a}].${e}`,""),r.setFieldValue(`addressDTOS[${a}].${e}Id`,0)},Ge=async()=>{console.log("Loading provinces...");const e=localStorage.getItem("provinces");if(e)console.log("Using cached provinces."),B(JSON.parse(e));else{console.log("Fetching provinces from API...");const t=await ze();console.log("Fetched provinces:",t),B(t),localStorage.setItem("provinces",JSON.stringify(t))}};v.extend(gt);const Ke=async()=>{try{const e=await g.get(`${T.apiPrefix}/address`);Xe(e.data)}catch(e){console.error("Error fetching addresses:",e)}},q=async(e,t)=>{try{const r=await g.get(`${T.apiPrefix}/customer/customer-infor/${e}`,{params:{page:t>0?t-1:0,size:w}});if(r.status===200){const a=r.data;if(console.log("Tổng số địa chỉ: ",a.totalAddresses),console.log("Tổng số trang: ",a.totalAddresses/w),a.totalAddresses&&(Le(a.totalAddresses),qe(Math.ceil(a.totalAddresses/w))),Re({currentEmail:a.email,currentPhone:a.phone}),console.log("Giá trị birthDate từ backend:",a.birthDate),a.birthDate){const i=v(a.birthDate,"DD-MM-YYYY");console.log("Parsed Date:",i.format()),i.isValid()?(a.birthDate=i.format("YYYY-MM-DD"),console.log("Formatted birthDate:",a.birthDate)):console.error("Ngày sinh không hợp lệ:",a.birthDate)}j(a),console.log("Customer data:",a),C(r.data.addressDTOS.map(()=>"edit"))}else console.error("Failed to fetch customer data:",r.statusText)}catch(r){console.error("Error fetching customer data:",r)}},_e=e=>{K(e),$(!0)},J=()=>{$(!1),K(null)},Je=async(e,t,r,a)=>{if(a.isDefault){$(!1),x.success("Không thể xóa địa chỉ mặc định");return}try{const i=await g.delete(`${T.apiPrefix}/address/delete/${e}`);i.status===200?(x.success("Xóa thành công"),r(t),C(D=>D.filter((P,d)=>d!==t)),$(!1)):(console.error("Lỗi khi xóa địa chỉ:",i.statusText),x.success("Xóa thất bại"))}catch(i){console.error("Lỗi xóa khách hàng:",i),x.success("Xóa thất bại")}},Qe=e=>{if(e<1){console.warn("Số trang phải lớn hơn hoặc bằng 1");return}y?(We(e),q(y,e)):console.error("Email is undefined")},Ze=async(e,{setSubmitting:t})=>{try{if(!v(e.birthDate,"YYYY-MM-DD",!0).isValid()){alert("Ngày sinh không hợp lệ. Vui lòng kiểm tra lại."),t(!1);return}const r=v(e.birthDate,"YYYY-MM-DD").format("DD-MM-YYYY");(await g.put(`${T.apiPrefix}/customer/update/${e.id}`,{...e,birthDate:r})).status===200?(x.success("Cập nhật thành công"),Be(`/customer/${y}`)):alert("Failed to update customer. Please try again.")}catch(r){console.error("Error updating customer:",r),alert("Error updating customer. Please try again.")}finally{t(!1)}},et=async(e,t,r,a,i,D,P,d)=>{try{if(!t.name||!t.phone||!t.province||!t.district||!t.ward||!t.detail){D(`addressDTOS[${i}].name`,!0),D(`addressDTOS[${i}].phone`,!0),D(`addressDTOS[${i}].province`,!0),D(`addressDTOS[${i}].district`,!0),D(`addressDTOS[${i}].ward`,!0),D(`addressDTOS[${i}].detail`,!0);return}let l;if(e==="add")l=await g.post(`${T.apiPrefix}/customer/${a}/address`,t),console.log("Dữ liệu địa chỉ vừa thêm:",l.data),l.status===201&&(P("addressDTOS",[l.data,...d.addressDTOS]),C(h=>["edit",...h])),x.success("Thêm địa chỉ mới thành công");else{l=await g.put(`${T.apiPrefix}/address/update/${r}`,{...t,districtId:t.districtId,wardId:t.wardId});const h=[...d.addressDTOS];h[i]=l.data,console.log("dữ liệu cập nhật lại địa chỉ: ",h),x.success("Cập nhật địa chỉ thành công")}q(a,E)}catch(l){console.error("Error submitting address:",l),alert("Error submitting address. Please try again.")}},tt=async(e,t)=>{try{console.log("Updating address ID:",e,"to default:",t);const r=await g.put(`${T.apiPrefix}/customer/${e}/default`,null,{params:{customerId:m.id,isDefault:t}});r.status===200?(console.log("Địa chỉ đã được cập nhật thành công:",r.data),Ke()):console.error("Cập nhật địa chỉ không thành công:",r.statusText)}catch(r){console.error("Lỗi khi cập nhật địa chỉ:",r)}},st=async(e,t)=>{try{const r=m.addressDTOS.map((a,i)=>({...a,isDefault:i===e}));j({...m,addressDTOS:r}),x.success("cập nhật địa chỉ mặc định thành công"),await tt(m.addressDTOS[e].id,!0)}catch(r){console.error("Lỗi khi cập nhật địa chỉ mặc định:",r)}},at=async e=>{if(e.addressDTOS[0].provinceId){const t=await Y(e.addressDTOS[0].provinceId);if(I(t),e.addressDTOS[0].districtId){const r=await A(e.addressDTOS[0].districtId);N(r)}}};return s.jsx(lt,{initialValues:m,validationSchema:Ue,enableReinitialize:!0,onSubmit:Ze,children:({values:e,setFieldValue:t,touched:r,errors:a,resetForm:i,isSubmitting:D,setFieldTouched:P})=>s.jsx(ot,{children:s.jsxs("div",{className:"w-full bg-white p-6 shadow-md rounded-lg",children:[s.jsx("h1",{className:"text-center font-semibold text-2xl mb-4 uppercase",children:"Cập nhật khách hàng"}),s.jsxs("div",{className:"flex flex-col lg:flex-row gap-4",children:[s.jsxs("div",{className:"w-full lg:w-1/3 bg-white p-6 shadow-md rounded-lg",children:[s.jsx("h4",{className:"font-medium text-xl mb-4",children:"Thông tin khách hàng"}),s.jsxs(Ye,{children:[s.jsx(p,{asterisk:!0,label:"Tên khách hàng",invalid:a.name&&r.name,errorMessage:a.name,children:s.jsx(f,{type:"text",autoComplete:"off",name:"name",style:{height:"44px"},placeholder:"Tên khách hàng...",component:O})}),s.jsx(p,{asterisk:!0,label:"Email",invalid:a.email&&r.email,errorMessage:a.email,children:s.jsx(f,{type:"text",autoComplete:"off",name:"email",style:{height:"44px"},placeholder:"Email...",component:O})}),s.jsx(p,{asterisk:!0,label:"Số điện thoại",invalid:a.phone&&r.phone,errorMessage:a.phone,children:s.jsx(f,{type:"text",autoComplete:"off",name:"phone",style:{height:"44px"},placeholder:"Số điện thoại...",component:O,onChange:d=>{const l=d.target.value.replace(/\D/g,"");t("phone",l),j(h=>({...h,phone:l}))}})}),s.jsx(p,{asterisk:!0,label:"Ngày sinh",invalid:a.birthDate&&r.birthDate,errorMessage:a.birthDate,children:s.jsx(dt,{inputtable:!0,inputtableBlurClose:!1,placeholder:"Chọn ngày sinh...",value:m.birthDate?v(m.birthDate,"YYYY-MM-DD").toDate():null,disableDate:d=>v(d).isAfter(v().endOf("day")),className:"custom-datepicker",onChange:d=>{if(d){const l=v(d).format("YYYY-MM-DD");t("birthDate",l),j(h=>({...h,birthDate:l}))}else t("birthDate",""),j(l=>({...l,birthDate:""}))}})}),s.jsx(p,{asterisk:!0,label:"Giới tính",children:s.jsx(f,{name:"gender",children:({field:d,form:l})=>s.jsxs(s.Fragment,{children:[s.jsx(Ae,{className:"mr-4",value:"Nam",checked:d.value==="Nam",onChange:()=>l.setFieldValue("gender","Nam"),children:"Nam"}),s.jsx(Ae,{value:"Nữ",checked:d.value==="Nữ",onChange:()=>l.setFieldValue("gender","Nữ"),children:"Nữ"})]})})}),s.jsxs(p,{children:[s.jsx(k,{type:"reset",className:"ltr:mr-2 rtl:ml-2",style:{backgroundColor:"#fff",height:"40px"},disabled:D,onClick:()=>{i(),at(m)},children:"Tải lại"}),s.jsx(k,{variant:"solid",type:"submit",style:{backgroundColor:"rgb(79, 70, 229)",height:"40px"},disabled:D,children:"Cập nhật"})]})]})]}),s.jsxs("div",{className:"w-full lg:w-2/3 bg-white p-6 shadow-md rounded-lg",children:[s.jsx("h4",{className:"font-medium text-xl",children:"Thông tin địa chỉ"}),s.jsx(ht,{name:"addressDTOS",children:({remove:d,unshift:l})=>s.jsxs("div",{children:[s.jsx(k,{type:"button",className:"mb-4 mt-4",onClick:()=>{l(L),C(["add",...M])},children:"Thêm địa chỉ mới"}),e.addressDTOS.map((h,n)=>{var Q,Z,ee,te,se,ae,re,ne,ie,ce,le,oe,de,he,ue,pe,ge,me,De,fe,be,Se,ve,Te,xe,ke,ye,Oe,je,we,Ne,Ce,$e,Pe,Ie,Ee;return s.jsxs("div",{className:"bg-white p-6 shadow-md rounded-lg mb-6",children:[s.jsxs(Ye,{children:[s.jsxs("h4",{className:"text-lg font-medium mb-2",children:["Địa chỉ ",(E-1)*w+n+1]}),s.jsxs("div",{className:"flex w-full flex-wrap mb-4",children:[s.jsx("div",{className:"w-1/2 pr-4",children:s.jsx(p,{asterisk:!0,label:"Tên",invalid:((Z=(Q=a.addressDTOS)==null?void 0:Q[n])==null?void 0:Z.name)&&((te=(ee=r.addressDTOS)==null?void 0:ee[n])==null?void 0:te.name),errorMessage:(ae=(se=a.addressDTOS)==null?void 0:se[n])==null?void 0:ae.name,children:s.jsx(f,{type:"text",name:`addressDTOS[${n}].name`,style:{height:"44px"},placeholder:"Nhập tên...",component:O})})}),s.jsx("div",{className:"w-1/2",children:s.jsx(p,{asterisk:!0,label:"Số điện thoại",invalid:((ne=(re=a.addressDTOS)==null?void 0:re[n])==null?void 0:ne.phone)&&((ce=(ie=r.addressDTOS)==null?void 0:ie[n])==null?void 0:ce.phone),errorMessage:(oe=(le=a.addressDTOS)==null?void 0:le[n])==null?void 0:oe.phone,children:s.jsx(f,{type:"text",name:`addressDTOS[${n}].phone`,style:{height:"44px"},placeholder:"Nhập số điện thoại...",component:O})})})]}),s.jsxs("div",{className:"flex w-full flex-wrap mb-4",children:[s.jsx("div",{className:"w-1/3 pr-4",children:s.jsx(p,{asterisk:!0,label:"Tỉnh/Thành phố",invalid:((he=(de=r.addressDTOS)==null?void 0:de[n])==null?void 0:he.province)&&!!((pe=(ue=a.addressDTOS)==null?void 0:ue[n])!=null&&pe.province),errorMessage:(me=(ge=a.addressDTOS)==null?void 0:ge[n])==null?void 0:me.province,children:s.jsx(f,{name:`addressDTOS[${n}].province`,children:({field:u,form:b})=>(console.log("Dữ liệu tỉnh:",u.value),s.jsx(V,{value:W.find(c=>c.NameExtension[1]===u.value),placeholder:"Chọn tỉnh/thành phố...",getOptionLabel:c=>c.NameExtension[1],getOptionValue:c=>String(c.ProvinceID),options:W,onChange:c=>{F("province",c,b,n)},onBlur:()=>b.setFieldTouched(u.value,!0)}))})})}),s.jsx("div",{className:"w-1/3 pr-4",children:s.jsx(p,{asterisk:!0,label:"Quận/huyện",invalid:((fe=(De=r.addressDTOS)==null?void 0:De[n])==null?void 0:fe.district)&&!!((Se=(be=a.addressDTOS)==null?void 0:be[n])!=null&&Se.district),errorMessage:(Te=(ve=a.addressDTOS)==null?void 0:ve[n])==null?void 0:Te.district,children:s.jsx(f,{name:`addressDTOS[${n}].district`,children:({field:u,form:b})=>(console.log("Dữ liệu quận:",u.value),s.jsx(V,{isDisabled:!h.province,value:H.find(c=>c.DistrictName===u.value),placeholder:"Chọn quận/huyện...",getOptionLabel:c=>c.DistrictName,getOptionValue:c=>String(c.DistrictID),options:H,onChange:c=>{F("district",c,b,n)},onBlur:()=>b.setFieldTouched(u.value,!0)}))})})}),s.jsx("div",{className:"w-1/3",children:s.jsx(p,{asterisk:!0,label:"Xã/phường/thị trấn",invalid:((ke=(xe=r.addressDTOS)==null?void 0:xe[n])==null?void 0:ke.ward)&&!!((Oe=(ye=a.addressDTOS)==null?void 0:ye[n])!=null&&Oe.ward),errorMessage:(we=(je=a.addressDTOS)==null?void 0:je[n])==null?void 0:we.ward,children:s.jsx(f,{name:`addressDTOS[${n}].ward`,children:({field:u,form:b})=>(console.log("Dữ liệu xã:",u.value),s.jsx(V,{isDisabled:!h.district,value:X.find(c=>c.WardName===u.value),placeholder:"Chọn xã/phường/thị trấn...",getOptionLabel:c=>c.WardName,getOptionValue:c=>String(c.WardCode),options:X,onChange:c=>{F("ward",c,b,n)},onBlur:()=>b.setFieldTouched(u.value,!0)}))})})})]}),s.jsx(p,{asterisk:!0,label:"Địa chỉ chi tiết",invalid:((Ce=(Ne=a.addressDTOS)==null?void 0:Ne[n])==null?void 0:Ce.detail)&&((Pe=($e=r.addressDTOS)==null?void 0:$e[n])==null?void 0:Pe.detail),errorMessage:(Ee=(Ie=a.addressDTOS)==null?void 0:Ie[n])==null?void 0:Ee.detail,children:s.jsx(f,{type:"text",name:`addressDTOS[${n}].detail`,style:{height:"44px"},placeholder:"Nhập địa chỉ chi tiết",component:O})}),s.jsx(p,{label:"Địa chỉ mặc định",children:s.jsx(f,{name:`addressDTOS[${n}].isDefault`,children:({field:u})=>s.jsx(ut,{color:"blue-600",checked:u.value,onChange:b=>{t(`addressDTOS[${n}].isDefault`,b),st(n)}})})}),s.jsxs("div",{className:"flex justify-end",children:[s.jsx(k,{type:"button",className:"mr-4",variant:"solid",style:{backgroundColor:"rgb(79, 70, 229)",height:"40px"},onClick:()=>et(M[n],e.addressDTOS[n],h.id,e.id,n,P,t,e),children:M[n]==="add"?"Thêm":"Cập nhật"}),s.jsx(k,{type:"button",variant:"default",style:{backgroundColor:"#fff",height:"40px"},onClick:()=>_e(h.id),children:"Xóa"})]})]}),s.jsxs(pt,{isOpen:He,closable:!1,onClose:J,children:[s.jsx("h5",{className:"mb-4",children:"Xác nhận xóa địa chỉ"}),s.jsx("p",{children:"Bạn có chắc chắn muốn xóa địa chỉ này không?"}),s.jsxs("div",{className:"text-right mt-6",children:[s.jsx(k,{className:"ltr:mr-2 rtl:ml-2",variant:"plain",onClick:J,children:"Hủy"}),s.jsx(k,{variant:"solid",style:{backgroundColor:"rgb(79, 70, 229)",height:"40px"},type:"submit",onClick:()=>Je(h.id,n,d,h),children:"Xác nhận"})]})]})]},n)})]})}),s.jsx("div",{children:s.jsx(mt,{current:E,pageSize:w,total:Ve,onChange:Qe})})]})]})]})})})};export{It as default};
