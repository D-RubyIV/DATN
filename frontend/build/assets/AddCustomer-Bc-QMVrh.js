import{at as ne,au as m,as as N,cg as me,bM as x,ch as De,r as h,aH as xe,aD as y,j as t,ax as Se,ay as Te,az as re,aA as o,aB as D,aC as v,ca as be,bf as de,ci as j,B as ce,aE as fe}from"./index-D4RF4o2o.js";const ve=ne({name:m().required("Họ tên khách hàng là bắt buộc").min(3,"Họ và tên khách hàng phải có ít nhất 3 ký tự").max(50,"Họ và tên khách hàng không vượt quá 50 ký tự").test("no-whitespace","Họ và tên không được chứa nhiều khoảng trắng",s=>s.trim()===s&&!s.includes("  ")).test("no-special-characters","Họ và tên không được chứa ký tự đặc biệt hoặc số",s=>/^[\p{L}\s]+$/u.test(s)),email:m().email("Email không hợp lệ").required("Email là bắt buộc").test("no-whitespace","Email không được chứa khoảng trắng đầu và cuối",s=>s.trim()===s).test("no-leading-trailing-dot","Email không được chứa dấu chấm ở đầu hoặc cuối",s=>s?!/^\./.test(s)&&!/\.$/.test(s):!0).test("no-consecutive-dots","Email không được chứa hai dấu chấm liên tiếp",s=>s?!/\.\./.test(s):!0).test("email-unique","Email đã tồn tại",async s=>!(await N.get("/customer/check-email",{params:{email:s}})).data.exists),phone:m().required("Số điện thoại là bắt buộc").matches(/(03|05|07|08|09|01[2|6|8|9])+([0-9]{8})\b/,"Số điện thoại không hợp lệ").test("valid-vietnam-phone","Số điện thoại phải bắt đầu bằng đầu số hợp lệ",s=>s?["03","05","07","08","09","012","016","018","019"].some(p=>s.startsWith(p)):!1).test("phone-unique","Số điện thoại đã tồn tại",async s=>!(await N.get("/customer/check-phone",{params:{phone:s}})).data.exists),birthDate:me().required("Ngày sinh là bắt buộc").max(new Date,"Ngày sinh không được là tương lai").test("age-range","Độ tuổi của bạn không đủ điều kiện để mua hàng",function(s){const u=x().diff(x(s),"year");return u>=10&&u<=100}),gender:m().required("Vui lòng chọn giới tính").oneOf(["Nam","Nữ"],"Giới tính không hợp lệ"),addressDTOS:De().of(ne().shape({province:m().required("Vui lòng chọn tỉnh/thành phố"),district:m().required("Vui lòng chọn quận/huyện"),ward:m().required("Vui lòng chọn xã/phường/thị trấn"),detail:m().required("Vui lòng nhập địa chỉ cụ thể").min(5,"Địa chỉ cụ thể phải có ít nhất 5 ký tự").max(200,"Địa chỉ cụ thể không vượt quá 200 ký tự").test("no-leading-trailing-whitespace","Không được có khoảng trắng đầu hoặc cuối",s=>s?s.trim()===s:!1).test("no-consecutive-whitespace","Không được chứa nhiều khoảng trắng liên tiếp",s=>s?!/\s{2,}/.test(s):!1).test("valid-characters","Chỉ được chứa ký tự chữ, số và dấu phân cách thông dụng",s=>s?/^[\p{L}0-9\s,.-]+$/u.test(s):!1)}))}),ke=()=>{const u={id:"",code:"",name:"",email:"",phone:"",birthDate:"",gender:"Nữ",addressDTOS:[{id:"",name:"",phone:"",provinceId:0,districtId:0,wardId:0,province:null,district:null,ward:null,detail:"",isDefault:!0}],status:"Active"},[p,w]=h.useState(u),[b,O]=h.useState([]),[f,S]=h.useState([]),[I,T]=h.useState([]),[le,C]=h.useState(!1),[he,F]=h.useState(!1),[oe,E]=h.useState(!1),ue=xe();h.useEffect(()=>{ge()},[]),h.useEffect(()=>{if(p.addressDTOS.length>0){const n=p.addressDTOS[0],e=n==null?void 0:n.province;if(e&&b.length>0){const r=b.find(l=>(l==null?void 0:l.NameExtension[1])===e);r?B(r.ProvinceID):S([])}else S([])}},[p.addressDTOS,b]),h.useEffect(()=>{if(p.addressDTOS.length>0){const n=p.addressDTOS[0],e=n==null?void 0:n.district;if(e&&f.length>0){const r=f.find(l=>l.DistrictName===e);r?P(r.DistrictID):T([])}else T([])}},[p.addressDTOS,f]);const ge=async()=>{C(!0);try{const n=await y.get("https://online-gateway.ghn.vn/shiip/public-api/master-data/province",{headers:{"Content-Type":"application/json",Token:"718f2008-46b7-11ef-b4a4-2ec170e33d11"}});console.log("API Province Response: ",n),n.data.code===200?O(n.data.data):(console.log("Error fetching province: ",n.data.message),O([]),alert("Không thể tải danh sách tỉnh. Vui lòng thử lại sau."))}catch(n){console.log("Error fetching province: ",n),O([]),alert("Đã xảy ra lỗi khi tải danh sách tỉnh. Vui lòng thử lại.")}finally{C(!1)}},B=async n=>{F(!0);try{const e=await y.get("https://online-gateway.ghn.vn/shiip/public-api/master-data/district",{headers:{"Content-Type":"application/json",Token:"718f2008-46b7-11ef-b4a4-2ec170e33d11"},params:{province_id:n}});console.log("API District Response: "+e),e.data.code===200?S(e.data.data):(console.log("Error fetching district: ",e.data.message),S([]),alert("Không thể tải danh sách huyện. Vui lòng thử lại sau."))}catch(e){console.error("Error fetching districts:",e),S([]),alert("Đã xảy ra lỗi khi tải danh sách huyện. Vui lòng thử lại.")}finally{F(!1)}},P=async n=>{E(!0);try{const e=await y.get(`https://online-gateway.ghn.vn/shiip/public-api/master-data/ward?${n}`,{headers:{"Content-Type":"application/json",Token:"718f2008-46b7-11ef-b4a4-2ec170e33d11"},params:{district_id:n}});console.log("API Ward Response: "+e),e.data.code===200?T(e.data.data):(console.log("Error fetching ward: ",e.data.message),T([]),alert("Không thể tải danh sách xã. Vui lòng thử lại sau."))}catch(e){console.log("Error fetching ward: ",e),T([]),alert("Đã xảy ra lỗi khi tải danh sách xã. Vui lòng thử lại.")}finally{E(!1)}},k=(n,e,r)=>{e&&w(l=>{const c=[...l.addressDTOS],a=c[0];return n==="province"&&"ProvinceName"in e?(a.provinceId=e.ProvinceID,a.province=e==null?void 0:e.NameExtension[1],a.districtId=0,a.district=null,a.wardId=0,a.ward=null,r.setFieldValue("addressDTOS[0].provinceId",a.provinceId),r.setFieldValue("addressDTOS[0].province",a.province),r.setFieldValue("addressDTOS[0].districtId",a.districtId),r.setFieldValue("addressDTOS[0].district",a.district),r.setFieldValue("addressDTOS[0].warId",a.wardId),r.setFieldValue("addressDTOS[0].ward",a.ward),B(e.ProvinceID)):n==="district"&&"DistrictName"in e?(a.districtId=e.DistrictID,a.district=e.DistrictName,a.wardId=0,a.ward=null,r.setFieldValue("addressDTOS[0].districtId",a.districtId),r.setFieldValue("addressDTOS[0].district",a.district),r.setFieldValue("addressDTOS[0].wardId",a.wardId),r.setFieldValue("addressDTOS[0].ward",a.ward),P(e.DistrictID)):n==="ward"&&"WardCode"in e&&(a.wardId=e.WardCode,a.ward=e.WardName,r.setFieldValue("addressDTOS[0].wardId",a.wardId),r.setFieldValue("addressDTOS[0].ward",a.ward)),{...l,addressDTOS:c}})},pe=async(n,{resetForm:e,setSubmitting:r})=>{try{const l={...n,birthDate:x(n.birthDate).format("DD-MM-YYYY")};console.log("Submitting formatted values:",l);const c=await N.post("/customer/save",l);fe.success("Lưu thành công"),e(),c.status===201&&ue("/admin/manage/customer")}catch{r(!1)}};return t.jsx(Se,{initialValues:u,validationSchema:ve,onSubmit:pe,children:({setFieldValue:n,resetForm:e,isSubmitting:r,values:l,errors:c,touched:a})=>{var q,M,W,Y,L,V,A,$,H,K,R,G,_,z,Q,X,J,U,Z,ee,te,se,ae,ie;return t.jsx(Te,{children:t.jsxs("div",{className:"bg-white p-6 shadow-md rounded-lg mb-6 w-full",children:[t.jsx("h1",{className:"text-center font-semibold text-2xl mb-4 text-transform: uppercase",children:"Thêm khách hàng"}),t.jsx("h4",{className:"font-medium text-xl mb-4",children:"Thông tin khách hàng"}),t.jsxs("div",{className:"flex w-full",children:[t.jsx("div",{className:"w-full lg:w-1/2 pr-4",children:t.jsxs(re,{children:[t.jsx(o,{asterisk:!0,label:"Họ tên khách hàng",invalid:a.name&&!!c.name,errorMessage:c.name,children:t.jsx(D,{type:"text",autoComplete:"on",name:"name",placeholder:"Nhập họ tên khách hàng...",style:{height:"44px"},component:v})}),t.jsx(o,{asterisk:!0,label:"Email",invalid:a.email&&!!c.email,errorMessage:c.email,children:t.jsx(D,{type:"text",autoComplete:"on",name:"email",style:{height:"44px"},placeholder:"Nhập email...",component:v})}),t.jsx(o,{asterisk:!0,label:"Số điện thoại",invalid:a.phone&&!!c.phone,errorMessage:c.phone,children:t.jsx(D,{type:"tel",autoComplete:"on",name:"phone",style:{height:"44px"},placeholder:"Nhập số điện thoại...",component:v,onChange:d=>{const i=d.target.value.replace(/\D/g,"");n("phone",i),w(g=>({...g,phone:i}))}})}),t.jsx(o,{asterisk:!0,label:"Ngày sinh",invalid:a.birthDate&&!!c.birthDate,errorMessage:c.birthDate,children:t.jsx(be,{inputtable:!0,inputtableBlurClose:!1,placeholder:"Chọn ngày sinh...",value:l.birthDate?x(l.birthDate,"YYYY-MM-DD").toDate():null,disableDate:d=>x(d).isAfter(x().endOf("day")),onChange:d=>{const i=d?x(d).format("YYYY-MM-DD"):"";n("birthDate",i)}})}),t.jsx(o,{asterisk:!0,label:"Giới tính",children:t.jsx(D,{name:"gender",children:({field:d,form:i})=>t.jsxs(t.Fragment,{children:[t.jsx(de,{className:"mr-4",value:"Nam",checked:d.value==="Nam",onChange:()=>i.setFieldValue("gender","Nam"),onBlur:()=>i.setFieldTouched("gender",!0),children:"Nam"}),t.jsx(de,{value:"Nữ",checked:d.value==="Nữ",onChange:()=>i.setFieldValue("gender","Nữ"),onBlur:()=>i.setFieldTouched("gender",!0),children:"Nữ"})]})})})]})}),t.jsx("div",{className:"w-full lg:w-1/2 pl-4",children:t.jsxs(re,{children:[t.jsx(o,{asterisk:!0,label:"Tỉnh/thành phố",invalid:((M=(q=a.addressDTOS)==null?void 0:q[0])==null?void 0:M.province)&&!!((Y=(W=c.addressDTOS)==null?void 0:W[0])!=null&&Y.province),errorMessage:(V=(L=c.addressDTOS)==null?void 0:L[0])==null?void 0:V.province,children:t.jsx(D,{name:"addressDTOS[0].province",children:({field:d,form:i})=>t.jsx(j,{isDisabled:le,value:b.find(g=>g.NameExtension[1]===l.addressDTOS[0].province)||null,placeholder:"Chọn tỉnh/thành phố...",style:{height:"40px"},getOptionLabel:g=>g.NameExtension[1],getOptionValue:g=>String(g.ProvinceID),options:b,onChange:g=>{k("province",g,i),i.setFieldTouched(d.name,!0,!1)},onBlur:()=>i.setFieldTouched(d.name,!0)})})}),t.jsx(o,{asterisk:!0,label:"Quận/huyện",invalid:(($=(A=a.addressDTOS)==null?void 0:A[0])==null?void 0:$.district)&&!!((K=(H=c.addressDTOS)==null?void 0:H[0])!=null&&K.district),errorMessage:(G=(R=c.addressDTOS)==null?void 0:R[0])==null?void 0:G.district,children:t.jsx(D,{name:"addressDTOS[0].district",children:({form:d})=>t.jsx(j,{isDisabled:he,value:f.find(i=>i.DistrictName===l.addressDTOS[0].district)||null,placeholder:"Chọn quận/huyện...",style:{height:"40px"},getOptionLabel:i=>i.DistrictName,getOptionValue:i=>String(i.DistrictID),options:f,onChange:i=>{k("district",i,d),d.setFieldValue("addressDTOS[0].district",i?i.DistrictName:""),d.setFieldTouched("addressDTOS[0].district",!0,!1)},onBlur:()=>d.setFieldTouched("addressDTOS[0].district",!0)})})}),t.jsx(o,{asterisk:!0,label:"Xã/phường/thị trấn",invalid:((z=(_=a.addressDTOS)==null?void 0:_[0])==null?void 0:z.ward)&&!!((X=(Q=c.addressDTOS)==null?void 0:Q[0])!=null&&X.ward),errorMessage:(U=(J=c.addressDTOS)==null?void 0:J[0])==null?void 0:U.ward,children:t.jsx(D,{name:"addressDTOS[0].ward",children:({form:d})=>t.jsx(j,{isDisabled:oe,value:I.find(i=>i.WardName===l.addressDTOS[0].ward)||null,placeholder:"Chọn xã/phường/thị trấn...",style:{height:"40px"},getOptionLabel:i=>i.WardName,getOptionValue:i=>String(i.WardCode),options:I,onChange:i=>{k("ward",i,d),d.setFieldValue("addressDTOS[0].ward",i?i.WardName:""),d.setFieldTouched("addressDTOS[0].ward",!0,!1)},onBlur:()=>d.setFieldTouched("addressDTOS[0].ward",!0)})})}),t.jsx(o,{asterisk:!0,label:"Địa chỉ cụ thể",invalid:((ee=(Z=a.addressDTOS)==null?void 0:Z[0])==null?void 0:ee.detail)&&!!((se=(te=c.addressDTOS)==null?void 0:te[0])!=null&&se.detail),errorMessage:(ie=(ae=c.addressDTOS)==null?void 0:ae[0])==null?void 0:ie.detail,children:t.jsx(D,{type:"text",autoComplete:"on",name:"addressDTOS[0].detail",style:{height:"44px"},placeholder:"Nhập địa chỉ cụ thể...",component:v})}),t.jsxs(o,{children:[t.jsx(ce,{type:"reset",style:{backgroundColor:"#fff",height:"40px"},className:"ltr:mr-2 rtl:ml-2",disabled:r,onClick:()=>{e({values:u}),S([]),T([]),n("addressDTOS[0].province",null)},children:"Tải lại"}),t.jsx(ce,{variant:"solid",style:{backgroundColor:"rgb(79, 70, 229)",height:"40px"},type:"submit",disabled:r,children:"Lưu"})]})]})})]})]})})}})};export{ke as default};
